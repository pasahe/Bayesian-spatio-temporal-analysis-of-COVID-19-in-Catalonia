---
title: "Distribució error ABS agregats"

#Data d'avui: Surt segons idioma d R
date: "`r format(Sys.time(), '%d %B, %Y')`"
 
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile,
      encoding=encoding, 
      output_file=file.path(dirname('P:/TFM'),'TFM/5_Productes/Analysis_Spatial.html')) })
 
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
##Estil 
    theme: cosmo 
    highlight: tango
###número seccions
    number_sections: true

---

```{r results='hide', echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}
rm(list=ls())
library(gtsummary)
library(INLA)
library(captioner)
library(dplyr)
library(kableExtra)
library(ggplot2)
library(effectsize)
library(tidyr)
library(purrr)
library(lubridate)
library(stringr)
library(plotly)
#Enumerar taules i figures
fig_nums <- captioner(prefix = 'Figure')
tab_nums <- captioner(prefix = 'Table')
citef <- pryr::partial(fig_nums, display = 'cite')
citet <- pryr::partial(tab_nums, display = 'cite')
###############
setwd('P:/TFM')
dades_ana <- 'P:/TFM/2_Dades/2_Analisi'

#Load all incidences from the global of CAT
load(file.path(dades_ana, "dat_cat.Rda"))

#Load DIC & WAIC of spatial models
load(file.path(dades_ana,"sp_dic_waic.Rda"))

#Load RR of spatial models
load(file.path(dades_ana, "res_sp.Rda"))

#Load hyperparameters of BYM2 spatial model
load(file.path(dades_ana, "bym2_hp.Rda"))

```

# DIC & WAIC

We will compare the time series of DIC and WAIC values between using a BYM or a BYM2 model. We don't expect to get optimal DIC and WAIC with BYM2, but similar values. 

`r tab_nums("dic_waic", "Description of estimated DIC and WAIC for BYM and BYM2 spatial models")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
theme_gtsummary_journal(journal = "jama")
list("style_number-arg:big.mark" = "") %>%
    set_gtsummary_theme()

sp_dic_waic %>% 
  mutate(
    model = toupper(model)
  ) %>% 
  pivot_longer(cols = c(dic, waic), names_to = "type", values_to = "val") %>% 
  pivot_wider(names_from = outcomes, values_from = val) %>% 
  dplyr::select(
    model, type, cas, hosp, vac 
  ) %>% 
  tbl_strata(
    strata = model,
    ~.x %>% 
      tbl_summary(
        by = type,
        label = list(
          cas ~ "Cases",
          hosp ~ "Hospitalization",
          vac ~ "Vaccination"
        ),
        type = list(all_continuous() ~ "continuous2"),
        statistic = list(
          all_continuous2() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")
        ),
        digits = list(all_continuous2() ~ 2),
        missing = "no"
      ) %>% 
      modify_header(label = "",
                  stat_1 = "**DIC**",
                  stat_2 = "**WAIC**") 
  ) %>% 
  as_kable_extra() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

`r fig_nums("dic", "Evolution of DIC for BYM and BYM2 spatial models on the SIR of covid-19 cases")`

```{r echo = FALSE, warning = FALSE, message = FALSE}

cas_dic <- sp_dic_waic %>% 
  filter(outcomes == "cas") %>% 
  dplyr::select(data, model, dic)

ggplot(data = cas_dic, aes(x = data, y = dic, color = model)) +
  geom_point() +
  geom_line(aes(group = model)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%Y - %m") +
  labs(x = "Date", y = "DIC") +
  scale_color_discrete(name = "Model") +
  theme_minimal()

```

`r fig_nums("waic", "Evolution of WAIC for BYM and BYM2 spatial models on the SIR of covid-19 cases")`

```{r echo = FALSE, warning = FALSE, message = FALSE}

cas_waic <- sp_dic_waic %>% 
  filter(outcomes == "cas") %>% 
  dplyr::select(data, model, waic)

ggplot(data = cas_waic, aes(x = data, y = waic, color = model)) +
  geom_point() +
  geom_line(aes(group = model)) +
  scale_x_date(date_breaks = "3 months", date_labels = "%Y - %m") +
  labs(x = "Date", y = "WAIC") +
  scale_color_discrete(name = "Model") +
  theme_minimal()
```

Points and lines overlap so there is no difference in the estimated DIC and WAIC between both models.

# RR

We calculate the SMD from Cohen's d between the estimates of RR and the estimated p of the two different models for each date. We don't calculate the difference in p because of such small values.

```{r echo = FALSE, warning = FALSE, message = FALSE}
dat_smd <- tibble(expand.grid(data = unique(res_sp$data), outcomes = c("cas", "hosp", "vac"), var = c("rr", "p"))) %>%
  mutate(
    smd = pmap_dbl(list(data, outcomes, var), function(x, y, z) {
      df <- res_sp %>%
        filter(data == x, outcomes == y) %>% 
        rename("z" = z)
      
      bym <- df %>% 
        filter(model == "bym") %>% 
        pull(z)
      bym2 <- df %>% 
        filter(model == "bym2") %>% 
        pull(z)
      if(!identical(bym, bym2)) {
        abs(cohens_d(bym, bym2, data = df, paired = TRUE)$Cohens_d)
      } else {
        0
      }
    }),
    var = factor(var, levels = c("rr", "p"), labels = c("RR", "p"))
  )
    
```

## Cases

`r fig_nums("plot_rr_cas", "Plot of the evolution of the SMD calculated between the RR and the p estimated with both models of the outcome case, along with the evolution of the case incidence in the total of Catalonia")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
sdat_smd <- dat_smd %>% 
  filter(outcomes == "cas")

#Start date of each wave
# data_inici <- dmy(c("25/02/2020","01/10/2020","07/12/2020","15/03/2021","13/06/2021","02/11/2021"))

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_cas", "", .x))  
  # mutate(
  #   xint = case_when(
  #     data %in% data_inici ~ data
  #   )
  # )
    
# ggplot(data=evodat,aes(x = month, fill = year_cat))+
#     geom_bar(aes(y = int), stat="identity", position = position_dodge(), alpha = 0.6) + 
#     #Hem de multiplicar per 20 i després en el axis dividirem per 20 per escalar-ho amb el primer axis:
#     geom_point(aes(y = perc_int*20, color =year_cat)) +
#     geom_line(aes(y = perc_int*20, group = year_cat, color = year_cat)) +
#     scale_y_continuous(name = "Nº Intervenciones", sec.axis = sec_axis(~./20, name="% Intervenciones", breaks = seq(0,60,10))) + 
#     scale_color_discrete(name = "Año") + 
#     scale_fill_discrete(name = "Año") +
#     xlab("Mes")

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sdat_smd, aes(x = data, y = smd*2000, group = var, color = var), alpha = 0.5) +
  geom_line(data = sdat_smd, aes(x = data, y = smd*2000, group = var, color = var), alpha = 0.5) +
  scale_color_manual(name = "", values = c("#00BFC4", "#7CAE00")) +
  geom_hline(yintercept = 0.1*2000, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = 0.2*2000, color = "black", linetype = "dashed", alpha = 0.5) +
  scale_y_continuous(name = "Case incidence", sec.axis = sec_axis(~./2000, name = "SMD"))

# ggplot(data = dat_smd, aes(x = data, y = smd, group = outcomes, color = outcomes)) +
#   facet_grid(. ~ var) +
#   geom_line() +
#   geom_point() +
#   geom_hline(yintercept = 0.1, color = "black", size = 0.1) +
#   geom_hline(yintercept = 0.2, color = "black", size = 0.1) + 
#   scale_color_discrete(name = "", labels = c("Cases", "Hospitalization", "Vaccination"))
```

There is no date with differences in the estimated RR. There is only one date with differences in the estimated value of p. It's precisely the first date with reported cases where the majority of areas had no cases so probability was 0 and thus it has very small standard deviation. Then, because the Cohen's D means the proportion of the standard deviation that differs small perturbations can cause high SMD values.

`r tab_nums("rr_bym_bym2", "RR and p estimated by BYM and BYM2 models")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
taula <- res_sp %>% 
  filter(outcomes == "cas", data == ymd("2020-03-08")) %>% 
  group_by(data, model) %>% 
  summarise(
    rr = str_glue("{round(mean(rr), 4)} ({round(sd(rr), 4)})"),
    p = str_glue("{round(mean(p), 4)} ({round(sd(p), 4)})"),
  ) %>% 
  pivot_wider(names_from = model, values_from = c(rr, p)) %>% 
  dplyr::select(data, rr_bym, p_bym, rr_bym2, p_bym2)

names(taula) <- c("data", rep(c("RR", "p"), 2))

kable(taula) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  add_header_above(c(" " = 1, "BYM" = 2, "BYM2" = 2))
```

## Hospitalization

`r fig_nums("plot_rr_hosp", "Plot of the evolution of the SMD calculated between the RR estimated with both models of the outcome hospitalization, along with the evolution of the hospitalization rate in the total of Catalonia")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
sdat_smd <- dat_smd %>% 
  filter(outcomes == "hosp")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_hosp", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sdat_smd, aes(x = data, y = smd*50, group = var, color = var), alpha = 0.5) +
  geom_line(data = sdat_smd, aes(x = data, y = smd*50, group = var, color = var), alpha = 0.5) +
  scale_color_manual(name = "", values = c("#00BFC4", "#7CAE00")) +
  geom_hline(yintercept = 0.1*50, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = 0.2*50, color = "black", linetype = "dashed", alpha = 0.5) +
  scale_y_continuous(name = "Hospitalization rate", sec.axis = sec_axis(~./50, name = "SMD"))

```
For the estimated RR, there is no date that has a high SMD. For the estimated p values we can see that the SMD is always high. Let's compare the mean and standard devaition of all dates of the p values.

`r tab_nums("rr_bym_bym2_2", "Mean and SD of the differences of RR and p estimated by BYM and BYM2 models for all dates")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
theme_gtsummary_journal(journal = "jama")

res_sp %>% 
  filter(outcomes == "hosp") %>% 
  group_by(data, abs) %>% 
  summarise(
    rr = diff(rr),
    p = diff(p)
  ) %>% 
  ungroup() %>% 
  dplyr::select(rr, p) %>% 
  tbl_summary(
    label = list(rr ~ "RR differences", p ~ "p differences"),
    type = list(all_continuous() ~ "continuous2"),
    statistic = list(all_continuous2() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")),
    digits = list(all_continuous2() ~ 4)
  ) %>% 
  modify_header(label = "") %>% 
  as_kable_extra() %>% 
  kable_styling(bootstrap_options = c("striped","hover"))

```

## Vaccination

`r fig_nums("plot_rr_vac", "Plot of the evolution of the SMD calculated between the RR estimated with both models of the outcome vaccination, along with the evolution of the fully vaccinated percentage in the total of Catalonia")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
sdat_smd <- dat_smd %>% 
  filter(outcomes == "vac")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_vac", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sdat_smd, aes(x = data, y = smd*50, group = var, color = var), alpha = 0.5) +
  geom_line(data = sdat_smd, aes(x = data, y = smd*50, group = var, color = var), alpha = 0.5) +
  scale_color_manual(name = "", values = c("#00BFC4", "#7CAE00")) +
  geom_hline(yintercept = 0.1*50, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = 0.2*50, color = "black", linetype = "dashed", alpha = 0.5) +
  scale_y_continuous(name = "Fully vaccinated %", sec.axis = sec_axis(~./50, name = "SMD"))

```
There're only differences in the beginning of the vaccination rates, let's see the real differences in the estimated RR and p values of these dates.

`r tab_nums("rr_bym_bym2_3", "RR and p estimated by BYM and BYM2 models")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
taula <- res_sp %>% 
  filter(outcomes == "vac", data %in% c(ymd("2021-01-03"), ymd("2021-01-10"), ymd("2021-01-10"), ymd("2021-01-17"), ymd("2021-01-24"))) %>% 
  group_by(data, model) %>% 
  summarise(
    rr = str_glue("{round(mean(rr), 4)} ({round(sd(rr), 4)})"),
    p = str_glue("{round(mean(p), 4)} ({round(sd(p), 4)})"),
  ) %>% 
  pivot_wider(names_from = model, values_from = c(rr, p)) %>% 
  dplyr::select(data, rr_bym, p_bym, rr_bym2, p_bym2)

names(taula) <- c("data", rep(c("RR", "p"), 2))

kable(taula) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  add_header_above(c(" " = 1, "BYM" = 2, "BYM2" = 2))
```

# BYM2 hyperparameters

As we have seen, DIC and WAIC values are similar between the two models and also the estimated relative risk have few differences. Therefore, we would choose BYM2 as it performs similar as BYM and its parameters are interpretable.

## $\phi$ (spatially structured correlation)

The mixing parameter $\phi$ represents the proportion of the marginal variance explained by the structured spatial effect over the non-structured one. Let's see how it changes over time, for each outcome:

### Cases

`r fig_nums("evo_phi_cas", "Evolution of the estimated values of the Phi hyperparameter of the BYM2 model for the outcome cases, along with the evolution of the case incidence")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
sbym2_hp <- bym2_hp %>% 
  filter(outcomes == "cas")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_cas", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sbym2_hp, aes(x = data, y = Phi*3000), alpha = 0.5, color = "#00BFC4") +
  geom_line(data = sbym2_hp, aes(x = data, y = Phi*3000, group = 1), alpha = 0.5, color = "#00BFC4") +
  geom_hline(yintercept = 0.5*3000, linetype = "dashed") +
  scale_y_continuous(name = "Case incidence", sec.axis = sec_axis(~./3000, name = "Phi", breaks = c(0, 0.25, 0.75, 1)))
```

### Hospitalization

`r fig_nums("evo_phi_hosp", "Evolution of the estimated values of the Phi hyperparameter of the BYM2 model for the outcome hospitalization, along with the evolution of the hospitalization rate")`

```{r echo = FALSE, warning = FALSE, message = FALSE}

sbym2_hp <- bym2_hp %>% 
  filter(outcomes == "hosp")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_hosp", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sbym2_hp, aes(x = data, y = Phi*50), alpha = 0.5, color = "#00BFC4") +
  geom_line(data = sbym2_hp, aes(x = data, y = Phi*50, group = 1), alpha = 0.5, color = "#00BFC4") +
  geom_hline(yintercept = 0.5*50, linetype = "dashed") +
  scale_y_continuous(name = "Hospitalization rate", sec.axis = sec_axis(~./50, name = "Phi", breaks = c(0, 0.25, 0.5, 0.75, 1)))

```

### Vaccination

`r fig_nums("evo_phi_vac", "Evolution of the estimated values of the Phi hyperparameter of the BYM2 model for the outcome vaccination, along with the evolution of the fully vaccination percentage")`

```{r echo = FALSE, warning = FALSE, message = FALSE}

sbym2_hp <- bym2_hp %>% 
  filter(outcomes == "vac")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_vac", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sbym2_hp, aes(x = data, y = Phi*80), alpha = 0.5, color = "#00BFC4") +
  geom_line(data = sbym2_hp, aes(x = data, y = Phi*80, group = 1), alpha = 0.5, color = "#00BFC4") +
  geom_hline(yintercept = 0.5*80, linetype = "dashed") +
  scale_y_continuous(name = "Fully vaccination %", sec.axis = sec_axis(~./80, name = "Phi", breaks = c(0, 0.25, 0.5, 0.75, 1)))

```

## SD ($1/\sqrt{\tau_b}$)

The parameter $\tau_b$ represents the marginal precision and controls the pure variability explained by a spatial effect (taking the inverse). Let's see how it changes over time for each outcome:

### Cases

`r fig_nums("evo_prec_cas", "Evolution of the estimated values of the standard deviation given by the precision hyperparameter of the BYM2 model for the outcome cases, along with the evolution of the case incidence")`

```{r echo = FALSE, warning = FALSE, message = FALSE}
sbym2_hp <- bym2_hp %>% 
  filter(outcomes == "cas")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_cas", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sbym2_hp, aes(x = data, y = SD*3200), alpha = 0.5, color = "#00BFC4") +
  geom_line(data = sbym2_hp, aes(x = data, y = SD*3200, group = 1), alpha = 0.5, color = "#00BFC4") +
  scale_y_continuous(name = "Case incidence", sec.axis = sec_axis(~./3200, name = "SD"))

```

### Hospitalization

`r fig_nums("evo_prec_hosp", "Evolution of the estimated values of the standard deviation given by the precision hyperparameter of the BYM2 model for the outcome hospitalization, along with the evolution of the hospitalization rate")`

```{r echo = FALSE, warning = FALSE, message = FALSE}

sbym2_hp <- bym2_hp %>% 
  filter(outcomes == "hosp")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_hosp", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sbym2_hp, aes(x = data, y = SD*40), alpha = 0.5, color = "#00BFC4") +
  geom_line(data = sbym2_hp, aes(x = data, y = SD*40, group = 1), alpha = 0.5, color = "#00BFC4") +
  scale_y_continuous(name = "Hospitalization rate", sec.axis = sec_axis(~./40, name = "SD"))

```

### Vaccination

`r fig_nums("evo_prec_vac", "Evolution of the estimated values of the standard deviation given by the precision hyperparameter of the BYM2 model for the outcome vaccination, along with the evolution of the fully vaccination percentage")`

```{r echo = FALSE, warning = FALSE, message = FALSE}

sbym2_hp <- bym2_hp %>% 
  filter(outcomes == "vac")

sdat_cat <- dat_cat %>% 
  rename_all(~ gsub("_vac", "", .x))  

ggplot(data = sdat_cat, aes(x = data, y = rate)) +
  geom_bar(stat = "identity",fill="#DD8888", alpha = 0.5)+
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") +
  theme_classic() + 
  theme(axis.line=element_blank(),axis.title.x=element_blank(), axis.ticks.y = element_blank()) +
  # geom_vline(aes(xintercept = xint), linetype = "dashed") +
  #Second axis:
  geom_point(data = sbym2_hp, aes(x = data, y = SD*45), alpha = 0.5, color = "#00BFC4") +
  geom_line(data = sbym2_hp, aes(x = data, y = SD*45, group = 1), alpha = 0.5, color = "#00BFC4") +
  scale_y_continuous(name = "Fully vaccination %", sec.axis = sec_axis(~./45, name = "SD"))

```

Except in the beginning, the vaccination has no variability at all across the areas, so there is no point on trying to estimate RR. We can illustrate it with this previous plot or even in a raw model to prevent us to calculate the spatial models? Maybe with a mixed model without any spatial effect we can see how the ICC of the areas are very low? And we can plot them for each date maybe.